<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE åŒ–å­¸ï¼šæ‘©çˆ¾æ¦‚å¿µäº’å‹•æ¸¬é©—</title>
    <!-- è¼‰å…¥ Tailwind CSS (éŸ¿æ‡‰å¼è¨­è¨ˆæ¡†æ¶) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ React, ReactDOM å’Œ Babel (ç”¨æ–¼è™•ç† JSX) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* è¨­å®šå­—é«”ç‚º Interï¼Œä¸¦ç¢ºä¿æ•´å€‹é é¢ä½ˆå±€æ¸…æ™° */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
        }
        /* è‡ªå®šç¾©æ•¸å­¸å…¬å¼æ¸²æŸ“çš„æ¨£å¼ï¼Œä½¿ç”¨ LaTeX æ ¼å¼ */
        .question-text p {
            display: inline;
        }
        .question-text .latex-math {
            display: inline-block;
            margin: 0 4px;
        }
        /* ç°¡å–®çš„æ—‹è½‰å‹•ç•« */
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
          animation: spin 3s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- React æ‡‰ç”¨ç¨‹å¼å°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
    </div>

    <script>
        // è¨­å®š Tailwind CSS é…ç½®
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#8b5cf6',
                    }
                }
            }
        }
        // æ¨¡æ“¬ç’°å¢ƒè®Šæ•¸ (åœ¨æ‚¨ç•¶å‰çš„é‹è¡Œç’°å¢ƒä¸­ï¼Œé€™äº›è®Šæ•¸æœƒè¢«è‡ªå‹•æ³¨å…¥)
        window.__app_id = 'classroom-quiz-dse-mole';
        window.__firebase_config = JSON.stringify({
            // **è«‹å‹™å¿…åœ¨æ­¤è™•æ›¿æ›æ‚¨çš„çœŸå¯¦ Firebase é‡‘é‘°**
  apiKey: "AIzaSyB0kVq7zSw1h4qG-6YbG-feDw_7bgr2uk4",
  authDomain: "sunchowdsechem.firebaseapp.com",
  projectId: "sunchowdsechem",
  storageBucket: "sunchowdsechem.firebasestorage.app",
  messagingSenderId: "277546472423",
  appId: "1:277546472423:web:f093f2603b1f38643a2342"
            // ...å…¶ä»–é…ç½®
        });
        window.__initial_auth_token = undefined;
    </script>
    
    <!-- è¼‰å…¥ Firebase SDK æ¨¡çµ„ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, orderBy, onSnapshot, deleteDoc, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // å»ºè­°åœ¨é–‹ç™¼/é™¤éŒ¯æ™‚é–‹å•Ÿ Firebase Log
        setLogLevel('Debug');

        // å°‡ Firebase ç›¸é—œå‡½æ•¸æ›è¼‰åˆ° windowï¼Œä»¥ä¾¿ JSX è…³æœ¬å¯ä»¥è¨ªå•
        window.firebaseDependencies = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, orderBy, onSnapshot, deleteDoc, runTransaction };
    </script>

    <!-- éŠæˆ²ç¨‹å¼ç¢¼å€å¡Š (ä½¿ç”¨ Babel è½‰è­¯ JSX) -->
    <script type="text/babel">
        // æ³¨æ„ï¼šç‚ºäº†åœ¨å–®ä¸€ HTML æ–‡ä»¶ä¸­é‹è¡Œï¼Œæˆ‘å€‘éœ€è¦å¾ window è®Šæ•¸ä¸­å–å¾— Firebase ä¾è³´
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, orderBy, onSnapshot, deleteDoc, runTransaction } = window.firebaseDependencies;

        const { useState, useEffect, useCallback, useMemo } = React;
        const ReactDOM = window.ReactDOM;

        // --- Global Constants and Configuration ---

        // åŸå­ç›¸å°è³ªé‡ (RAM) ç”¨æ–¼è¨ˆç®— (ç•¥)
        const RAM = { H: 1.0, C: 12.0, N: 14.0, O: 16.0, Na: 23.0, Cl: 35.5, Mg: 24.3, S: 32.1, K: 39.1, Br: 79.9, Ca: 40.1, Fe: 55.8, };
        const MAX_TIME_PER_QUESTION_SEC = 20;
        const BASE_SCORE = 1000;

        const calculateMolarMass = (formula) => {
            let mass = 0;
            const cleanFormula = formula.replace(/(\(|\))/g, '');
            const parts = cleanFormula.match(/([A-Z][a-z]*)(\d*)/g);
            if (!parts) return 0;
            
            parts.forEach(part => {
                const match = part.match(/([A-Z][a-z]*)(\d*)/);
                if (match) {
                    const element = match[1];
                    const count = match[2] ? parseInt(match[2], 10) : 1;
                    mass += (RAM[element] || 0) * count;
                }
            });
            return mass;
        };

        const initialQuestions = [
            // ç°¡åŒ–é¡Œç›®åº«ï¼Œé¿å…é‡è¤‡ (åƒ…ä¿ç•™å‰å¹¾é¡Œä½œç‚ºç¯„ä¾‹)
            { id: '0', tier: 'A', question: "æ‘©çˆ¾è³ªé‡çš„å–®ä½æ˜¯ä»€éº¼ï¼Ÿ", options: ['$\\text{g}$', '$\\text{mol}$', '$\\text{g/mol}$', '$\\text{g/L}$'], correct: 2 },
            { id: '1', tier: 'A', question: "ã€Œæ‘©çˆ¾ã€æ¦‚å¿µå°‡å·¨è§€è³ªé‡èˆ‡å“ªä¸€å€‹å¾®è§€å±¬æ€§è¯ç¹«èµ·ä¾†ï¼Ÿ", options: ['å¯†åº¦', 'é«”ç©', 'ç²’å­æ•¸', 'æº«åº¦'], correct: 2 },
            { id: '2', tier: 'B', question: `åœ¨ $46.0\\text{ g}$ çš„éˆ‰ ($\text{Na}$ï¼Œæ‘©çˆ¾è³ªé‡ $\\approx 23.0\\text{ g/mol}$) ä¸­æœ‰å¤šå°‘æ‘©çˆ¾ï¼Ÿ`, options: ['$1.0 \\text{ mol}$', '$2.0 \\text{ mol}$', '$0.5 \\text{ mol}$', '$46.0 \\text{ mol}$'], correct: 1, explanation: 'æ‘©çˆ¾æ•¸ = è³ªé‡ / æ‘©çˆ¾è³ªé‡ã€‚$46.0\\text{ g} / 23.0\\text{ g/mol} = 2.0 \\text{ mol}$' },
            { id: '3', tier: 'C', question: `è¨ˆç®— $36.0\\text{ g}$ æ°´ä¸­çš„ $\\text{H}_2\\text{O}$ åˆ†å­æ•¸ã€‚ (æ‘©çˆ¾è³ªé‡ $\\approx 18.0\\text{ g/mol}$ï¼Œ $N_A = 6.02 \\times 10^{23}$)`, options: ['$6.02 \\times 10^{23}$', '$12.04 \\times 10^{23}$', '$36.0$', '$3.01 \\times 10^{23}$'], correct: 1, explanation: 'æ‘©çˆ¾æ•¸ = $36.0/18.0 = 2.0 \\text{ mol}$ã€‚åˆ†å­æ•¸ = $2.0 \\times N_A = 12.04 \\times 10^{23}$' },
        ];


        // --- Firebase è¨­å®š (ä½¿ç”¨å…¨åŸŸè®Šæ•¸) ---

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: 'mock' };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        let app, db, auth;
        const isFirebaseConfigured = firebaseConfig.apiKey && firebaseConfig.apiKey !== 'YOUR_FIREBASE_API_KEY';

        if (isFirebaseConfigured) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } else {
            console.error("Firebase é…ç½®æœªè¨­ç½®ã€‚éŠæˆ²å°‡ç„¡æ³•åœ¨å¤šäººæ¨¡å¼ä¸‹ä¿å­˜æˆ–é‹è¡Œã€‚è«‹æª¢æŸ¥æ‚¨çš„ FIREBASE_API_KEYã€‚");
        }

        // --- Firestore è·¯å¾‘èˆ‡å‡½æ•¸ ---

        const getSessionPath = (code) => `artifacts/${appId}/public/data/quizSessions/${code}`;
        // æ–°å¢çš„ Players é›†åˆè·¯å¾‘
        const getPlayersCollectionPath = (code) => `artifacts/${appId}/public/data/quizSessions/${code}/players`;
        const getResponsesCollectionPath = (code) => `artifacts/${appId}/public/data/quizSessions/${code}/responses`;

        const signIn = async () => {
            let user;
            try {
                if (auth) {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    user = auth.currentUser;
                }
            } catch (error) {
                console.error("Firebase èº«ä»½é©—è­‰å¤±æ•—:", error);
            }
            return user;
        };

        // --- è¨ˆåˆ†é‚è¼¯ ---
        const calculateScore = (response, question, startTime) => {
            if (response.selectedOptionIndex !== question.correct) { return 0; }
            const timeTakenMs = response.timestamp - startTime;
            const timeTakenSec = timeTakenMs / 1000;
            const timeFactor = Math.max(0, 1 - (timeTakenSec / MAX_TIME_PER_QUESTION_SEC));
            return Math.round(BASE_SCORE + BASE_SCORE * timeFactor);
        };

        // --- éŠæˆ²ç‹€æ…‹ Context ---
        const GameContext = React.createContext();

        // --- çµ„ä»¶ ---

        /**
         * è‡ªå®šç¾© Hookï¼šç®¡ç† Firebase åˆå§‹åŒ–å’Œèº«ä»½é©—è­‰ç‹€æ…‹ã€‚
         */
        const useFirebaseAuthState = () => {
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [isConfigured] = useState(isFirebaseConfigured);

            useEffect(() => {
                if (!auth) {
                    setUserId(crypto.randomUUID());
                    setIsAuthReady(true);
                    return;
                }

                const bootstrapAuth = async () => {
                    let attempt = 0;
                    const maxAttempts = 5;
                    const baseDelay = 1000;

                    while (attempt < maxAttempts) {
                        try {
                            await signIn();
                            break;
                        } catch (error) {
                            attempt++;
                            if (attempt >= maxAttempts) {
                                console.error("å¤šæ¬¡å˜—è©¦å¾Œç™»éŒ„å¤±æ•—ã€‚", error);
                                setIsAuthReady(true);
                                return;
                            }
                            const delay = baseDelay * Math.pow(2, attempt) + Math.random() * 1000;
                            await new Promise(res => setTimeout(res, delay));
                        }
                    }
                };

                bootstrapAuth();
                
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    const currentId = user ? user.uid : crypto.randomUUID();
                    setUserId(currentId);
                    setIsAuthReady(true);
                });

                return () => {
                    if (auth) unsubscribe();
                };
            }, []);

            return { db, auth, userId, isAuthReady, isConfigured };
        };

        /**
         * æ¸²æŸ“ä¸»è¦æ‡‰ç”¨ç¨‹å¼ã€‚
         */
        function App() {
            const [view, setView] = useState('HOME'); // HOME, HOST, PLAYER
            const [gameCode, setGameCode] = useState('');
            const [playerName, setPlayerName] = useState('');
            const { db, auth, userId, isAuthReady, isConfigured } = useFirebaseAuthState();

            if (!isAuthReady) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-900 text-white">
                        <svg className="animate-spin-slow h-8 w-8 mr-3 text-indigo-400" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p className="text-xl">æ­£åœ¨åˆå§‹åŒ–éŠæˆ²æœå‹™...</p>
                    </div>
                );
            }

            const contextValue = { db, auth, userId, gameCode, setGameCode, playerName, setPlayerName, isConfigured };

            let ContentComponent;
            if (view === 'HOST') {
                ContentComponent = HostView;
            } else if (view === 'PLAYER') {
                ContentComponent = PlayerView;
            } else {
                ContentComponent = Home;
            }

            return (
                <GameContext.Provider value={contextValue}>
                    <div className="min-h-screen bg-gray-900 font-sans text-white">
                        <header className="py-4 px-6 shadow-lg bg-gray-800 flex justify-between items-center">
                            <h1 className="text-2xl font-extrabold text-indigo-400">
                                DSE åŒ–å­¸ï¼šæ‘©çˆ¾æ¦‚å¿µæ¸¬é©—
                            </h1>
                            <div className="text-sm opacity-70">
                                {view !== 'HOME' && userId && `ç”¨æˆ¶ ID: ${userId.substring(0, 8)}...`}
                            </div>
                        </header>
                        <main className="container mx-auto p-4 md:p-8">
                            {React.createElement(ContentComponent, { setView })}
                        </main>
                    </div>
                </GameContext.Provider>
            );
        }

        /**
         * é¦–é ï¼šé¸æ“‡ä¸»æŒäººæˆ–ç©å®¶è§’è‰²ã€‚
         */
        const Home = ({ setView }) => {
            const { setGameCode, setPlayerName, isConfigured } = React.useContext(GameContext);
            const [localCode, setLocalCode] = useState('');
            const [localName, setLocalName] = useState('');

            const handleJoin = () => {
                if (localCode.length === 6 && localName) {
                    setGameCode(localCode);
                    setPlayerName(localName);
                    setView('PLAYER');
                }
            };

            return (
                <div className="flex flex-col md:flex-row gap-8 mt-16 max-w-4xl mx-auto">
                    <Card title="é–‹å§‹æ–°æ¸¬é©— (æ•™å¸«/ä¸»æŒäºº)">
                        {isConfigured ? (
                            <>
                                <p className="text-gray-400 mb-4">
                                    å»ºç«‹æ–°çš„éŠæˆ²æœƒè©±ï¼Œæ§åˆ¶æ¸¬é©—çš„æµç¨‹ã€‚
                                </p>
                                <button
                                    onClick={() => setView('HOST')}
                                    className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.02]"
                                >
                                    ä¸»æŒéŠæˆ²
                                </button>
                            </>
                        ) : (
                            <p className="text-red-400 font-semibold">
                                ğŸš¨ ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Firebase é…ç½®ä»¥å•Ÿç”¨å¤šäººæ¨¡å¼ã€‚
                            </p>
                        )}
                    </Card>

                    <Card title="åŠ å…¥æ¸¬é©— (å­¸ç”Ÿ/ç©å®¶)">
                        <input
                            type="text"
                            placeholder="è¼¸å…¥ 6 ä½æ•¸éŠæˆ²ä»£ç¢¼"
                            maxLength="6"
                            value={localCode}
                            onChange={(e) => setLocalCode(e.target.value.toUpperCase().slice(0, 6))}
                            className="w-full p-3 mb-4 bg-gray-700 text-white rounded-lg placeholder-gray-400 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 transition"
                        />
                        <input
                            type="text"
                            placeholder="è¼¸å…¥æ‚¨çš„å§“å (ä¾‹å¦‚ï¼šJohn S.4A)"
                            value={localName}
                            onChange={(e) => setLocalName(e.target.value)}
                            className="w-full p-3 mb-6 bg-gray-700 text-white rounded-lg placeholder-gray-400 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 transition"
                        />
                        <button
                            onClick={handleJoin}
                            disabled={localCode.length !== 6 || !localName}
                            className={`w-full py-3 font-bold rounded-xl shadow-lg transition duration-200 ${
                                localCode.length === 6 && localName
                                    ? 'bg-green-600 hover:bg-green-700'
                                    : 'bg-gray-500 cursor-not-allowed'
                            }`}
                        >
                            åŠ å…¥éŠæˆ²
                        </button>
                    </Card>
                </div>
            );
        };

        /**
         * é€šç”¨å¡ç‰‡çµ„ä»¶ã€‚
         */
        const Card = ({ title, children, className = '' }) => (
            <div className={`flex-1 p-6 bg-gray-800 rounded-2xl shadow-2xl border-t-4 border-indigo-500 ${className}`}>
                <h2 className="text-3xl font-bold mb-4 text-indigo-400">{title}</h2>
                {children}
            </div>
        );

        /**
         * Host View (æ•™å¸«) çµ„ä»¶ã€‚
         */
        const HostView = ({ setView }) => {
            const { db, userId, isConfigured } = React.useContext(GameContext);
            const [gameCode, setGameCode] = useState('');
            const [session, setSession] = useState(null);
            // ç¾åœ¨å¾ players é›†åˆä¸­è®€å–ç©å®¶
            const [players, setPlayers] = useState([]); 
            const [responses, setResponses] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [isPlayerLoading, setIsPlayerLoading] = useState(false); 

            // 1. å»ºç«‹æ–°éŠæˆ²æœƒè©±
            const createNewGame = async () => {
                if (!db || !userId) return;
                setLoading(true);
                setError(null);

                const newCode = Math.random().toString(36).toUpperCase().substring(2, 8);
                const newSessionRef = doc(db, getSessionPath(newCode));

                const initialSessionData = {
                    gameCode: newCode,
                    hostId: userId,
                    status: 'WAITING',
                    currentQuestionIndex: -1,
                    currentQuestionStartTime: 0,
                    questions: initialQuestions,
                    totalQuestions: initialQuestions.length,
                };

                try {
                    await setDoc(newSessionRef, initialSessionData);
                    setGameCode(newCode);
                } catch (e) {
                    console.error("å‰µå»ºæœƒè©±æ™‚å‡ºéŒ¯: ", e);
                    setError("ç„¡æ³•å‰µå»ºéŠæˆ²æœƒè©±ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Firebase å®‰å…¨è¦å‰‡ (Security Rules) å’Œæ§åˆ¶å°ç²å–è©³ç´°ä¿¡æ¯ã€‚");
                } finally {
                    setLoading(false);
                }
            };

            // 2. å¯¦æ™‚æœƒè©±ç›£è½å™¨ (ç­‰å¾…å®¤, éŠæˆ²é€²åº¦)
            useEffect(() => {
                if (!db || !gameCode) return;

                const sessionRef = doc(db, getSessionPath(gameCode));
                const unsubscribeSession = onSnapshot(sessionRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().hostId === userId) {
                        setSession(docSnap.data());
                    } else if (docSnap.exists() && docSnap.data().hostId !== userId) {
                        setError("æ‚¨ä¸æ˜¯æ­¤æœƒè©±çš„ä¸»æŒäººã€‚");
                    } else {
                        setSession(null);
                    }
                }, (err) => {
                     console.error("Session Snapshot Error:", err);
                     setError("ç„¡æ³•è®€å–éŠæˆ²æœƒè©±ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Firebase å®‰å…¨è¦å‰‡ã€‚");
                });

                return () => unsubscribeSession();
            }, [db, gameCode, userId]);

            // 3. å¯¦æ™‚ç©å®¶åˆ—è¡¨ç›£è½å™¨ (æ–°å¢çš„ Players é›†åˆ)
            useEffect(() => {
                if (!db || !session || session.status === 'FINISHED') {
                    setPlayers([]);
                    return;
                }
                
                setIsPlayerLoading(true);
                const playersCollectionRef = collection(db, getPlayersCollectionPath(gameCode));
                const q = query(playersCollectionRef); 

                const unsubscribePlayers = onSnapshot(q, (snapshot) => {
                    const currentPlayers = snapshot.docs.map(d => d.data());
                    
                    // ğŸš¨ æ–°çš„é™¤éŒ¯æ—¥èªŒ: ç¢ºèªæˆ‘å€‘å¾ players é›†åˆæ”¶åˆ°äº†å¤šå°‘ç©å®¶
                    console.log(`[DEBUG] Players Snapshot Received. Total players: ${snapshot.docs.length}`);

                    setPlayers(currentPlayers.sort((a, b) => a.joinTime - b.joinTime));
                    setIsPlayerLoading(false);
                }, (err) => {
                    console.error("Players Snapshot Error:", err);
                    setIsPlayerLoading(false);
                    setError("ç„¡æ³•è®€å–å­¸ç”Ÿåˆ—è¡¨è³‡æ–™ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Firebase å®‰å…¨è¦å‰‡ã€‚");
                });

                return () => unsubscribePlayers();
            }, [db, session, gameCode]);

            // 4. å¯¦æ™‚éŸ¿æ‡‰ç›£è½å™¨ (åƒ…ç”¨æ–¼è¨ˆåˆ†å’Œå›ç­”çµ±è¨ˆ)
            useEffect(() => {
                if (!db || !session) {
                    setResponses([]);
                    return;
                }
                const responsesCollectionRef = collection(db, getResponsesCollectionPath(gameCode));
                const q = query(responsesCollectionRef); 

                const unsubscribeResponses = onSnapshot(q, (snapshot) => {
                    const currentResponses = snapshot.docs.map(d => d.data());
                    
                    // ğŸš¨ é€™æ˜¯èˆŠçš„é™¤éŒ¯æ—¥èªŒï¼Œç¾åœ¨ä¸»è¦ä¾è³´ Players Snapshot
                    console.log(`[DEBUG] Responses Snapshot Received. Total docs: ${snapshot.docs.length}`);

                    setResponses(currentResponses.sort((a, b) => a.timestamp - b.timestamp));
                }, (err) => {
                    console.error("Responses Snapshot Error:", err);
                });

                return () => unsubscribeResponses();
            }, [db, session, gameCode]);

            // 5. æ’è¡Œæ¦œè¨ˆç®—
            const leaderboard = useMemo(() => {
                if (!players.length) return [];

                const playerScores = players.reduce((acc, player) => {
                    acc[player.userId] = { 
                        name: player.name, 
                        score: 0, 
                        correctAnswers: 0,
                        lastAnswerTime: 0,
                        userId: player.userId
                    };
                    return acc;
                }, {});

                // è¨ˆç®—æ‰€æœ‰å•é¡Œçš„åˆ†æ•¸
                initialQuestions.forEach((q, qIndex) => {
                    const responsesForQ = responses.filter(r => r.questionIndex === qIndex);
                    responsesForQ.forEach(response => {
                        // ç¢ºä¿æœƒè©±æ•¸æ“šä¸­å­˜åœ¨è©²å•é¡Œçš„é–‹å§‹æ™‚é–“
                        const score = calculateScore(response, q, session?.currentQuestionStartTime || 0);
                        if (score > 0) {
                            // æª¢æŸ¥ç©å®¶æ˜¯å¦åœ¨ç•¶å‰ players åˆ—è¡¨ä¸­ (ä»¥é˜²æœ‰äººä¸­é€”é€€å‡ºä½†ä»æœ‰åˆ†æ•¸)
                            if (playerScores[response.userId]) {
                                playerScores[response.userId].score += score;
                                playerScores[response.userId].correctAnswers += 1;
                                playerScores[response.userId].lastAnswerTime = Math.max(playerScores[response.userId].lastAnswerTime, response.timestamp);
                            }
                        }
                    });
                });

                return Object.values(playerScores)
                    .sort((a, b) => {
                        if (b.score !== a.score) return b.score - a.score;
                        return a.lastAnswerTime - b.lastAnswerTime; // æ™‚é–“å¿«è€…å‹å‡ºå¹³å±€
                    })
                    .filter(p => p.score > 0 || p.correctAnswers > 0 || p.userId === userId || players.some(pl => pl.userId === p.userId)); 
            }, [session, players, responses, userId]);

            // 6. éŠæˆ²æ§åˆ¶å‡½æ•¸ (startGame, advanceQuestion, cleanupGame ä¿æŒä¸è®Š)

            const startGame = async () => {
                if (!db || !gameCode || session.status !== 'WAITING') return;

                const sessionRef = doc(db, getSessionPath(gameCode));
                try {
                    await updateDoc(sessionRef, {
                        status: 'IN_PROGRESS',
                        currentQuestionIndex: 0,
                        currentQuestionStartTime: Date.now(),
                    });
                } catch (e) {
                    setError("ç„¡æ³•é–‹å§‹éŠæˆ²ã€‚è«‹æª¢æŸ¥æ‚¨çš„é€£ç·šå’Œæ¬Šé™ã€‚");
                }
            };

            const advanceQuestion = async (direction) => {
                if (!db || !gameCode || session.status === 'FINISHED') return;

                let nextIndex = session.currentQuestionIndex + direction;

                if (nextIndex >= initialQuestions.length) {
                    nextIndex = initialQuestions.length; // çµæŸéŠæˆ²ç‹€æ…‹
                }
                
                const sessionRef = doc(db, getSessionPath(gameCode));
                
                try {
                    if (nextIndex < initialQuestions.length) {
                        // ä¸‹ä¸€å€‹å•é¡Œ
                        await updateDoc(sessionRef, {
                            currentQuestionIndex: nextIndex,
                            currentQuestionStartTime: Date.now(),
                        });
                    } else {
                        // çµæŸéŠæˆ²
                        await updateDoc(sessionRef, {
                            status: 'FINISHED',
                            currentQuestionIndex: nextIndex,
                        });
                    }
                } catch (e) {
                    setError("ç„¡æ³•åˆ‡æ›å•é¡Œã€‚è«‹æª¢æŸ¥æ‚¨çš„é€£ç·šå’Œæ¬Šé™ã€‚");
                }
            };

            const cleanupGame = async () => {
                if (!db || !gameCode) return;
                const isConfirmed = prompt("è«‹è¼¸å…¥ 'DELETE' ä»¥ç¢ºèªçµæŸä¸¦åˆªé™¤æ­¤æ¸¬é©—æ•¸æ“š:") === 'DELETE';
                if (isConfirmed) {
                    try {
                         await deleteDoc(doc(db, getSessionPath(gameCode)));
                         setView('HOME');
                    } catch (e) {
                        setError("ç„¡æ³•åˆªé™¤æœƒè©±ã€‚è«‹æª¢æŸ¥æ¬Šé™ã€‚");
                    }
                }
            };

            // --- æ¸²æŸ“ä¸»æŒäººè¦–åœ– ---

            if (!isConfigured) return <ErrorMessage message="å¤šäººéŠæˆ²åŠŸèƒ½éœ€è¦ Firebase è³‡æ–™åº«é€£æ¥ã€‚è«‹æª¢æŸ¥é…ç½®ã€‚" onBack={() => setView('HOME')} />;
            if (error) return <ErrorMessage message={error} onBack={() => setView('HOME')} />;


            if (!gameCode || !session) {
                return (
                    <div className="text-center mt-12">
                        <h2 className="text-4xl font-bold mb-8 text-indigo-400">ä¸»æŒæ–°æ¸¬é©—</h2>
                        <button
                            onClick={createNewGame}
                            disabled={loading}
                            className="py-4 px-8 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-xl rounded-xl shadow-lg transition duration-200"
                        >
                            {loading ? 'æ­£åœ¨å‰µå»º...' : 'ç”ŸæˆéŠæˆ²ä»£ç¢¼'}
                        </button>
                    </div>
                );
            }
            
            // ç­‰å¾…å®¤
            if (session.status === 'WAITING') {
                return (
                    <HostWaitingRoom
                        gameCode={gameCode}
                        players={players}
                        startGame={startGame}
                        cleanupGame={cleanupGame}
                        isLoading={isPlayerLoading}
                    />
                );
            }

            // æ¸¬é©—é€²è¡Œä¸­ (ç•¥ï¼Œçµæ§‹èˆ‡èˆŠç‰ˆä¸€è‡´ï¼Œä½¿ç”¨ players åˆ—è¡¨)
            if (session.status === 'IN_PROGRESS') {
                const currentQ = session.questions[session.currentQuestionIndex];
                const responsesForQ = responses.filter(r => r.questionIndex === session.currentQuestionIndex);
                
                return (
                    <HostQuiz
                        session={session}
                        currentQ={currentQ}
                        responses={responsesForQ}
                        leaderboard={leaderboard}
                        advanceQuestion={advanceQuestion}
                        totalPlayers={players.length}
                    />
                );
            }

            // éŠæˆ²çµæŸ (ç•¥)
            if (session.status === 'FINISHED') {
                return (
                    <HostFinished
                        leaderboard={leaderboard}
                        cleanupGame={cleanupGame}
                    />
                );
            }
        };

        /**
         * Host - ç­‰å¾…å®¤çµ„ä»¶
         */
        const HostWaitingRoom = ({ gameCode, players, startGame, cleanupGame, isLoading }) => (
            <div className="text-center max-w-5xl mx-auto">
                <h2 className="text-5xl font-extrabold mb-4 text-indigo-400">ç­‰å¾…å®¤</h2>
                <div className="bg-gray-800 p-8 rounded-2xl shadow-2xl inline-block">
                    <p className="text-2xl mb-2 text-gray-300">è«‹å­¸ç”ŸåŠ å…¥ï¼š</p>
                    <p className="text-7xl font-mono tracking-widest bg-indigo-600 p-4 rounded-xl shadow-inner my-4">
                        {gameCode}
                    </p>
                    <p className="text-lg text-gray-400">ç¸½é¡Œæ•¸ï¼š{initialQuestions.length}</p>
                </div>

                <h3 className="text-3xl font-bold mt-8 mb-4">
                    å·²é€£æ¥ç©å®¶ ({players.length})
                    {isLoading && (
                        <svg className="animate-spin-slow h-6 w-6 inline-block ml-3 text-indigo-400" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    )}
                </h3>
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 max-h-80 overflow-y-auto p-2 bg-gray-800 rounded-xl shadow-inner">
                    {players.length === 0 && !isLoading ? (
                        <p className="col-span-6 text-gray-500 py-4">æš«ç„¡å­¸ç”ŸåŠ å…¥ã€‚</p>
                    ) : (
                        players.map((player) => (
                            <div key={player.userId} className="p-3 bg-gray-700 rounded-lg text-lg font-semibold truncate hover:bg-indigo-500 transition duration-150">
                                {player.name}
                            </div>
                        ))
                    )}
                     {isLoading && players.length === 0 && (
                        <p className="col-span-6 text-indigo-400 py-4">æ­£åœ¨è¼‰å…¥ç©å®¶æ•¸æ“š...</p>
                    )}
                </div>

                <div className="mt-8 flex justify-center gap-4">
                    <button
                        onClick={startGame}
                        disabled={players.length === 0}
                        className={`py-3 px-6 text-xl font-bold rounded-xl transition duration-200 ${
                            players.length > 0
                                ? 'bg-green-600 hover:bg-green-700 shadow-xl'
                                : 'bg-gray-600 cursor-not-allowed'
                        }`}
                    >
                        é–‹å§‹æ¸¬é©—
                    </button>
                    <button
                        onClick={cleanupGame}
                        className="py-3 px-6 bg-red-600 hover:bg-red-700 text-white font-bold text-xl rounded-xl shadow-xl transition duration-200"
                    >
                        çµæŸæœƒè©±
                    </button>
                </div>
            </div>
        );

        /**
         * Host - æ¸¬é©—é€²è¡Œä¸­çµ„ä»¶ (ç•¥)
         */
        const HostQuiz = ({ session, currentQ, responses, leaderboard, advanceQuestion, totalPlayers }) => {
            const qIndex = session.currentQuestionIndex;
            const totalQ = session.totalQuestions;

            const totalResponses = responses.filter(r => r.questionIndex === qIndex).length; 
            const remainingTime = Math.max(0, MAX_TIME_PER_QUESTION_SEC - Math.floor((Date.now() - session.currentQuestionStartTime) / 1000));
            const isTimeUp = remainingTime === 0;
            const isQuestionOver = totalResponses >= totalPlayers || isTimeUp;

            // éŸ¿æ‡‰åˆ†ä½ˆ
            const optionCounts = currentQ.options.map((_, index) =>
                responses.filter(r => r.questionIndex === qIndex && r.selectedOptionIndex === index).length
            );
            const maxCount = Math.max(...optionCounts, 1);

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
                    {/* å·¦æ¬„ï¼šå•é¡Œèˆ‡æ§åˆ¶ */}
                    <div className="lg:col-span-2">
                        <div className="bg-gray-800 p-6 rounded-2xl shadow-2xl">
                            <p className="text-xl font-semibold text-indigo-300 mb-2">
                                å•é¡Œ {qIndex + 1} / {totalQ} (é›£åº¦ {currentQ.tier})
                            </p>
                            <div className="text-5xl font-extrabold mb-6 text-white leading-snug question-text"
                                 dangerouslySetInnerHTML={{ __html: currentQ.question.replace(/(\$.*?\$(?:\s*|))/g, '<span class="latex-math">$1</span>') }} />

                            <div className="flex justify-between items-center mb-6">
                                <div className="text-3xl font-bold text-yellow-400">
                                    å‰©é¤˜æ™‚é–“: {remainingTime}s
                                </div>
                                <div className="text-3xl font-bold text-green-400">
                                    å·²å›ç­”: {totalResponses} / {totalPlayers}
                                </div>
                            </div>

                            {/* é¸é …ç¶²æ ¼èˆ‡çµæœ */}
                            <div className="grid grid-cols-2 gap-4">
                                {currentQ.options.map((option, index) => {
                                    const isCorrect = index === currentQ.correct;
                                    const percentage = totalResponses > 0 ? Math.round((optionCounts[index] / totalResponses) * 100) : 0;
                                    const barWidth = `${percentage}%`;

                                    return (
                                        <div
                                            key={index}
                                            className={`relative p-3 rounded-xl shadow-lg transition duration-300 overflow-hidden 
                                                ${isQuestionOver ? (isCorrect ? 'bg-green-700' : 'bg-red-700') : 'bg-gray-700'}`}
                                        >
                                            {isQuestionOver && (
                                                <div
                                                    className="absolute top-0 left-0 h-full opacity-50 transition-all duration-300"
                                                    style={{ width: barWidth, backgroundColor: isCorrect ? '#10B981' : '#EF4444' }}
                                                />
                                            )}
                                            <span className="relative z-10 text-xl font-bold"
                                                  dangerouslySetInnerHTML={{ __html: option.replace(/(\$.*?\$(?:\s*|))/g, '<span class="latex-math">$1</span>') }} />
                                            {isQuestionOver && (
                                                <span className="absolute right-3 z-10 text-xl font-bold">
                                                    {optionCounts[index]} ({percentage}%)
                                                </span>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                            
                            {isQuestionOver && currentQ.explanation && (
                                <div className="mt-4 p-4 bg-indigo-900 rounded-lg text-indigo-200">
                                    <p className="font-semibold">è§£é‡‹:</p>
                                    <p className="question-text" dangerouslySetInnerHTML={{ __html: currentQ.explanation.replace(/(\$.*?\$(?:\s*|))/g, '<span class="latex-math">$1</span>') }} />
                                </div>
                            )}
                        </div>
                        
                        {/* æ§åˆ¶æŒ‰éˆ• */}
                        <div className="mt-8 text-center">
                            <button
                                onClick={() => advanceQuestion(1)}
                                className={`py-3 px-8 text-xl font-bold rounded-xl transition duration-300 ${
                                    isQuestionOver || qIndex === 0
                                        ? 'bg-indigo-600 hover:bg-indigo-700 shadow-xl'
                                        : 'bg-gray-600 cursor-not-allowed'
                                }`}
                                disabled={!isQuestionOver && qIndex !== 0}
                            >
                                {qIndex + 1 < totalQ ? 'ä¸‹ä¸€é¡Œ >>' : 'æŸ¥çœ‹æœ€çµ‚æ’è¡Œæ¦œ >>'}
                            </button>
                        </div>
                    </div>

                    {/* å³æ¬„ï¼šæ’è¡Œæ¦œ */}
                    <LeaderboardCard leaderboard={leaderboard} title="å³æ™‚æ’è¡Œæ¦œ" />
                </div>
            );
        };

        /**
         * Host - éŠæˆ²çµæŸçµ„ä»¶ (ç•¥)
         */
        const HostFinished = ({ leaderboard, cleanupGame }) => (
            <div className="text-center max-w-4xl mx-auto mt-12">
                <h2 className="text-6xl font-extrabold text-yellow-400 mb-8 animate-pulse">ğŸ‰ æ¸¬é©—å®Œæˆï¼ ğŸ‰</h2>
                <LeaderboardCard leaderboard={leaderboard} title="æœ€çµ‚æ’è¡Œæ¦œ" className="mb-8" />
                <div className="mt-12 flex justify-center gap-4">
                    <button
                        onClick={cleanupGame}
                        className="py-3 px-8 bg-red-600 hover:bg-red-700 text-white font-bold text-xl rounded-xl shadow-xl transition duration-200"
                    >
                        çµæŸä¸¦æ¸…é™¤æœƒè©±
                    </button>
                </div>
            </div>
        );

        /**
         * å…±äº«æ’è¡Œæ¦œå¡ç‰‡ (ç•¥)
         */
        const LeaderboardCard = ({ leaderboard, title, className = '' }) => (
            <Card title={title} className={`shadow-inner ${className}`}>
                <div className="space-y-3 max-h-[80vh] overflow-y-auto pr-2">
                    {leaderboard.length === 0 ? (
                        <p className="text-gray-400">æš«ç„¡åˆ†æ•¸ã€‚</p>
                    ) : (
                        leaderboard.map((player, index) => (
                            <div
                                key={player.userId}
                                className={`flex justify-between items-center p-3 rounded-lg font-bold transition duration-300 ${
                                    index === 0 ? 'bg-yellow-500 text-gray-900 text-xl shadow-2xl scale-105'
                                    : index === 1 ? 'bg-gray-300 text-gray-900 text-lg'
                                    : index === 2 ? 'bg-yellow-700 text-white'
                                    : 'bg-gray-700 text-white'
                                }`}
                            >
                                <span className="w-8 text-center">{index + 1}</span>
                                <span className="flex-1 truncate mx-2">{player.name}</span>
                                <span className="text-right text-2xl tracking-wider">{player.score}</span>
                            </div>
                        ))
                    )}
                </div>
            </Card>
        );

        /**
         * Player View (å­¸ç”Ÿ) çµ„ä»¶ã€‚
         */
        const PlayerView = ({ setView }) => {
            const { db, userId, gameCode, playerName } = React.useContext(GameContext);
            const [session, setSession] = useState(null);
            const [myResponse, setMyResponse] = useState(null);
            const [leaderboard, setLeaderboard] = useState([]);
            const [error, setError] = useState(null);
            const [isJoining, setIsJoining] = useState(true); // æ–°å¢ç‹€æ…‹ï¼šæ­£åœ¨åŠ å…¥éŠæˆ²

            // 0. å­¸ç”ŸåŠ å…¥éŠæˆ²æ™‚å¯«å…¥ Players é›†åˆ (æ–°å¢çš„é‚è¼¯)
            useEffect(() => {
                if (!db || !userId || !gameCode || !playerName || !isJoining) return;
                
                const playerRef = doc(db, getPlayersCollectionPath(gameCode), userId);
                
                // å¯«å…¥/æ›´æ–°ç©å®¶è³‡æ–™ï¼Œé€™æœƒè®“ä¸»æŒäººçœ‹åˆ°å­¸ç”Ÿ
                const playerDocData = {
                    userId,
                    name: playerName,
                    joinTime: Date.now(),
                };
                
                setDoc(playerRef, playerDocData)
                    .then(() => {
                        console.log(`[PLAYER] æˆåŠŸåŠ å…¥éŠæˆ²: ${playerName}`);
                        setIsJoining(false); // å¯«å…¥æˆåŠŸå¾Œï¼Œåœæ­¢åŠ å…¥ç‹€æ…‹
                    })
                    .catch(e => {
                        console.error("[PLAYER] åŠ å…¥éŠæˆ²å¤±æ•— (å¯«å…¥ Player Doc å¤±æ•—): ", e);
                        setError("ç„¡æ³•åŠ å…¥éŠæˆ²ã€‚éŠæˆ²ä»£ç¢¼å¯èƒ½ç„¡æ•ˆæˆ–ä¼ºæœå™¨é€£ç·šå•é¡Œã€‚");
                        setIsJoining(false);
                    });

            }, [db, userId, gameCode, playerName, isJoining]); // ä¾è³´ isJoining

            // 1. å¯¦æ™‚æœƒè©±ç›£è½å™¨ (ç•¥ï¼Œçµæ§‹èˆ‡èˆŠç‰ˆä¸€è‡´)
            useEffect(() => {
                if (!db || !gameCode) return;
                const sessionRef = doc(db, getSessionPath(gameCode));

                const unsubscribe = onSnapshot(sessionRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setSession(docSnap.data());
                        const data = docSnap.data();
                        if (data.status === 'IN_PROGRESS' && data.currentQuestionIndex !== (session?.currentQuestionIndex ?? -1)) {
                            setMyResponse(null);
                        }
                    } else {
                        setError("éŠæˆ²æœƒè©±æœªæ‰¾åˆ°æˆ–å·²è¢«ä¸»æŒäººçµæŸã€‚");
                        setSession(null);
                    }
                }, (err) => console.error("Player Session Snapshot Error:", err));

                return () => unsubscribe();
            }, [db, gameCode, session?.currentQuestionIndex]);

            // 2. å¯¦æ™‚æ’è¡Œæ¦œ/éŸ¿æ‡‰ç›£è½å™¨ (ç•¥ï¼Œçµæ§‹èˆ‡èˆŠç‰ˆä¸€è‡´)
            useEffect(() => {
                if (!db || !gameCode) return;

                const responsesCollectionRef = collection(db, getResponsesCollectionPath(gameCode));
                const q = query(responsesCollectionRef); 

                const unsubscribeResponses = onSnapshot(q, (snapshot) => {
                    const currentResponses = snapshot.docs.map(d => d.data());
                    
                    const playerScores = currentResponses.reduce((acc, response) => {
                        const qIndex = response.questionIndex;
                        const question = initialQuestions[qIndex];
                        
                        if (!acc[response.userId]) {
                            acc[response.userId] = { name: response.name, score: 0, lastAnswerTime: 0, userId: response.userId };
                        }

                        if (session && question) {
                            const score = calculateScore(response, question, 0); 
                            if (score > 0) {
                                 acc[response.userId].score += score;
                                 acc[response.userId].lastAnswerTime = Math.max(acc[response.userId].lastAnswerTime, response.timestamp);
                            }
                        }
                        return acc;
                    }, {});

                    setLeaderboard(Object.values(playerScores)
                        .sort((a, b) => b.score - a.score)
                        .filter(p => p.score > 0 || p.userId === userId)
                    );

                    const currentQIndex = session?.currentQuestionIndex ?? -1;
                    const latestResponse = currentResponses.find(r => r.userId === userId && r.questionIndex === currentQIndex);
                    setMyResponse(latestResponse);

                }, (err) => console.error("Player Responses Snapshot Error:", err));

                return () => unsubscribeResponses();
            }, [db, gameCode, session, userId]);


            // 3. æäº¤ç­”æ¡ˆçš„å‹•ä½œ (ç•¥ï¼Œçµæ§‹èˆ‡èˆŠç‰ˆä¸€è‡´)
            const submitAnswer = async (selectedOptionIndex) => {
                if (!db || !session || myResponse || session.status !== 'IN_PROGRESS') return;

                const currentQIndex = session.currentQuestionIndex;
                // æ³¨æ„ï¼šFirestore æœƒè‡ªå‹•ç”Ÿæˆ IDï¼Œæˆ‘å€‘ä½¿ç”¨ collection(ref) ç„¶å¾Œä¸å‚³ docId
                const responseRef = doc(collection(db, getResponsesCollectionPath(gameCode))); 
                const responseData = {
                    userId,
                    name: playerName,
                    questionIndex: currentQIndex,
                    selectedOptionIndex,
                    timestamp: Date.now(),
                };

                try {
                    await setDoc(responseRef, responseData);
                    setMyResponse(responseData); 
                } catch (e) {
                    console.error("æäº¤ç­”æ¡ˆæ™‚å‡ºéŒ¯: ", e);
                    setError("æäº¤ç­”æ¡ˆå¤±æ•—ã€‚è«‹æª¢æŸ¥é€£ç·šæˆ–è¯ç¹«è€å¸«ã€‚"); 
                }
            };

            // --- æ¸²æŸ“ç©å®¶è¦–åœ– ---

            if (error) return <ErrorMessage message={error} onBack={() => setView('HOME')} />;

            if (!session || session.status === 'WAITING') {
                return (
                    <PlayerWaitingRoom
                        gameCode={gameCode}
                        playerName={playerName}
                        session={session}
                        isJoining={isJoining}
                    />
                );
            }

            if (session.status === 'IN_PROGRESS') {
                const currentQ = session.questions[session.currentQuestionIndex];
                const myScoreEntry = leaderboard.find(p => p.userId === userId) || { score: 0 };
                
                return (
                    <PlayerQuiz
                        currentQ={currentQ}
                        qIndex={session.currentQuestionIndex}
                        totalQ={session.totalQuestions}
                        myResponse={myResponse}
                        submitAnswer={submitAnswer}
                        myScore={myScoreEntry.score}
                        leaderboard={leaderboard}
                    />
                );
            }

            if (session.status === 'FINISHED') {
                return (
                    <PlayerFinished
                        leaderboard={leaderboard}
                        myScore={leaderboard.find(p => p.userId === userId)?.score || 0}
                        setView={setView}
                    />
                );
            }
        };

        /**
         * Player - ç­‰å¾…å®¤çµ„ä»¶
         */
        const PlayerWaitingRoom = ({ gameCode, playerName, session, isJoining }) => {
            
            return (
                <div className="text-center max-w-lg mx-auto mt-24 bg-gray-800 p-8 rounded-2xl shadow-2xl">
                    <h2 className="text-4xl font-extrabold mb-4 text-indigo-400">æ­¡è¿, {playerName}!</h2>
                    <p className="text-xl text-gray-300 mb-6">æ‚¨å·²åŠ å…¥éŠæˆ²ä»£ç¢¼:</p>
                    <p className="text-6xl font-mono tracking-widest bg-indigo-600 p-4 rounded-xl shadow-inner my-4">
                        {gameCode}
                    </p>
                    <p className="text-2xl font-semibold mt-8 text-yellow-400">
                        {isJoining ? 'æ­£åœ¨é€£ç·šä¸­...' : 'æ­£åœ¨ç­‰å¾…ä¸»æŒäººé–‹å§‹æ¸¬é©—...'}
                    </p>
                </div>
            );
        };

        /**
         * Player - æ¸¬é©—é€²è¡Œä¸­çµ„ä»¶ (ç•¥)
         */
        const PlayerQuiz = ({ currentQ, qIndex, totalQ, myResponse, submitAnswer, myScore, leaderboard }) => {
            const isAnswered = !!myResponse;
            const myRank = leaderboard.findIndex(p => p.userId === myResponse?.userId) + 1;

            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex justify-between items-center mb-6">
                        <p className="text-xl font-semibold text-indigo-300">
                            å•é¡Œ {qIndex + 1} / {totalQ}
                        </p>
                        <p className="text-xl font-semibold text-green-400">
                            æˆ‘çš„åˆ†æ•¸: {myScore} (æ’å: {myRank > 0 ? myRank : '--'})
                        </p>
                    </div>
                    
                    <Card title="æ‘©çˆ¾æ¦‚å¿µæ¸¬é©—">
                        <div className="text-4xl font-extrabold mb-8 text-white leading-snug text-center question-text"
                             dangerouslySetInnerHTML={{ __html: currentQ.question.replace(/(\$.*?\$(?:\s*|))/g, '<span class="latex-math">$1</span>') }} />

                        {isAnswered && (
                            <div className={`p-4 rounded-xl text-center text-2xl font-bold mb-4 animate-pulse bg-indigo-600`}>
                                âœ… ç­”æ¡ˆå·²æˆåŠŸæäº¤ï¼æ­£åœ¨ç­‰å¾…è€å¸«åˆ‡æ›ä¸‹ä¸€é¡Œ...
                            </div>
                        )}
                        
                        <div className="grid grid-cols-2 gap-4">
                            {currentQ.options.map((option, index) => {
                                const isSelected = isAnswered && myResponse.selectedOptionIndex === index;

                                let btnClass = 'bg-gray-700 hover:bg-gray-600';
                                if (isAnswered) {
                                    if (isSelected) {
                                        btnClass = 'bg-yellow-600 shadow-yellow-400/50';
                                    } else {
                                        btnClass = 'bg-gray-700 opacity-50 cursor-not-allowed';
                                    }
                                }
                                
                                return (
                                    <button
                                        key={index}
                                        onClick={() => submitAnswer(index)}
                                        disabled={isAnswered}
                                        className={`py-4 px-3 text-xl font-bold text-left rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.01] ${btnClass} ${!isAnswered ? 'cursor-pointer' : 'cursor-default'}`}
                                    >
                                        <span className="mr-2 opacity-70">{String.fromCharCode(65 + index)}.</span>
                                        <span dangerouslySetInnerHTML={{ __html: option.replace(/(\$.*?\$(?:\s*|))/g, '<span class="latex-math">$1</span>') }} />
                                    </button>
                                );
                            })}
                        </div>
                    </Card>
                </div>
            );
        };

        /**
         * Player - éŠæˆ²çµæŸçµ„ä»¶ (ç•¥)
         */
        const PlayerFinished = ({ leaderboard, myScore, setView }) => {
            const { userId } = React.useContext(GameContext);
            const myRank = leaderboard.findIndex(p => p.userId === userId) + 1;
            const totalPlayers = leaderboard.length;

            return (
                <div className="text-center max-w-4xl mx-auto mt-12">
                    <h2 className="text-6xl font-extrabold text-yellow-400 mb-8">éŠæˆ²çµæŸï¼</h2>
                    <div className="bg-gray-800 p-8 rounded-2xl shadow-2xl mb-8">
                        <p className="text-4xl font-bold text-indigo-400">æ‚¨çš„æœ€çµ‚åˆ†æ•¸:</p>
                        <p className="text-7xl font-extrabold text-white my-4">{myScore}</p>
                        <p className="text-3xl font-semibold text-green-400">
                            æ‚¨çš„æ’å: {myRank} / {totalPlayers}
                        </p>
                    </div>
                    <div className="mt-8 flex justify-center gap-4">
                        <button
                            onClick={() => setView('HOME')}
                            className="py-3 px-8 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-xl rounded-xl shadow-xl transition duration-200"
                        >
                            è¿”å›ä¸»é 
                        </button>
                    </div>
                </div>
            );
        };

        /**
         * å…±äº«éŒ¯èª¤è¨Šæ¯çµ„ä»¶ (ç•¥)
         */
        const ErrorMessage = ({ message, onBack }) => (
            <div className="text-center max-w-lg mx-auto mt-24 bg-red-900 p-8 rounded-2xl shadow-2xl">
                <h2 className="text-3xl font-extrabold mb-4 text-red-400">ç™¼ç”ŸéŒ¯èª¤</h2>
                <p className="text-xl text-white mb-6">{message}</p>
                <button
                    onClick={onBack}
                    className="py-2 px-6 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl transition duration-200"
                >
                    è¿”å›
                </button>
            </div>
        );

        // å•Ÿå‹• React æ‡‰ç”¨ç¨‹å¼
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
